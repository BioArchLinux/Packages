# Maintainer: Pekka Ristola <pekkarr [at] protonmail [dot] com>
# Contributor: Josh Sixsmith <josh dot sixsmith at gmail dot com>
# Contributor: Morteza NourelahiAlamdari <m@0t1.me>

pkgname=tiledb
pkgver=2.17.2
pkgrel=1
pkgdesc="The Universal Storage Engine"
arch=(x86_64)
url="https://tiledb.com"
license=(MIT)
depends=(
  bzip2
  capnproto
  curl
  file
  fmt
  lz4
  openssl
  spdlog
  zlib
  zstd
)
makedepends=(
  cmake
)
source=("$pkgname-$pkgver.tar.gz::https://github.com/TileDB-Inc/TileDB/archive/$pkgver.tar.gz"
        "system-libs.patch")
sha256sums=('fff42d79e8db9829ab2d7efac2a3aa0d9fb949f7db2ac829ae61ebb8aafc74db'
            '47241a8b29d0094454be6b21fb5942bdb757e6f1cc72e4598d18eba405f15fc4')

prepare() {
  cd "TileDB-$pkgver"
  # use system libmagic and capnproto
  patch -Np1 -i ../system-libs.patch
}

build() {
  cmake -B build -S "TileDB-$pkgver" \
      -DCMAKE_BUILD_TYPE=None \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DTILEDB_SERIALIZATION=ON \
      -DTILEDB_TESTS=OFF \
      -DTILEDB_WEBP=OFF \
      -Wno-dev
  cmake --build build
}

package() {
  DESTDIR="$pkgdir" cmake --install build/tiledb
  install -Dm644 -t "$pkgdir/usr/share/licenses/$pkgname" "TileDB-$pkgver/LICENSE"
}
